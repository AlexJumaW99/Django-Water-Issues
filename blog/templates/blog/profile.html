{% extends "blog/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
  <div class="content-section">
    <!-- Profile Header Section -->
    <div class="profile-header">
      <div class="row">
        <div class="col-md-3">
          <img class="rounded-circle account-img" src="{{ profile_user.profile.image.url }}" alt="{{ profile_user.username }}">
        </div>
        <div class="col-md-9">
          <h2 class="account-heading">{{ profile_user.username }}</h2>
          <p class="text-secondary">{{ profile_user.email }}</p>
          
          {% if profile_user == request.user %}
            <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#editProfileModal">
              <i class="fas fa-edit" style="margin-right: 5px;"></i>Edit Profile
            </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Create Post Section (if it's the user's own profile) -->
    {% if profile_user == request.user %}
      <div class="mb-4">
        <button id="create-post-btn" class="btn btn-success">
          <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>Create a Post
        </button>
      </div>

      <div id="create-post-form" style="display: none;" class="content-section fade-in mb-4">
        <form method="POST">
          {% csrf_token %}
          <fieldset class="form-group">
            <legend class="border-bottom mb-4">
              <i class="fas fa-pen" style="margin-right: 10px;"></i>Create a New Post
            </legend>
            {{ post_form|crispy }}
          </fieldset>
          <div class="form-group">
            <button class="btn btn-outline-info" type="submit" name="create_post">
              <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Post
            </button>
            <button type="button" id="cancel-post-btn" class="btn btn-outline-secondary">
              <i class="fas fa-times" style="margin-right: 8px;"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    {% endif %}

    <!-- User's Posts Section -->
    <h3 class="mt-4 mb-3">
      <i class="fas fa-newspaper" style="margin-right: 8px;"></i>Posts by {{ profile_user.username }}
    </h3>
    {% for post in posts %}
      <article class="media content-section">
        <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}" alt="{{ post.author.username }}">
        <div class="media-body">
          <div class="article-metadata">
            <a class="mr-2" href="{% url 'blog-profile' post.author.id %}">
              <i class="fas fa-user" style="font-size: 0.85rem; margin-right: 4px;"></i>{{ post.author }}
            </a>
            <small class="text-muted">
              <i class="fas fa-clock" style="margin-right: 4px;"></i>{{ post.date_posted|date:"F d, Y" }}
            </small>
          </div>
          <h2><a class="article-title" href="{% url 'blog-post' post.id %}">{{ post.title }}</a></h2>
          <p class="article-content">{{ post.content }}</p>
        </div>
      </article>
    {% empty %}
      <p class="text-muted">
        <i class="fas fa-inbox" style="margin-right: 8px;"></i>No posts yet.
      </p>
    {% endfor %}
  </div>

  <!-- Edit Profile Modal -->
  {% if profile_user == request.user %}
  <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            {% csrf_token %}
            {{ u_form|crispy }}
            {{ p_form|crispy }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button class="btn btn-outline-info" type="submit" name="update_profile">Update Profile</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- JavaScript to handle form submission errors and toggle -->
  <script>
    {% if u_form.errors or p_form.errors %}
      // If there are form errors, reopen the modal
      $(document).ready(function() {
        $('#editProfileModal').modal('show');
      });
    {% endif %}

    // Toggle create post form
    document.addEventListener('DOMContentLoaded', function() {
      var createPostBtn = document.getElementById('create-post-btn');
      var createPostForm = document.getElementById('create-post-form');
      var cancelPostBtn = document.getElementById('cancel-post-btn');

      if (createPostBtn) {
        createPostBtn.addEventListener('click', function() {
          if (createPostForm.style.display === 'none' || createPostForm.style.display === '') {
            createPostForm.style.display = 'block';
            this.innerHTML = '<i class="fas fa-minus-circle" style="margin-right: 8px;"></i>Cancel';
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-secondary');
          } else {
            createPostForm.style.display = 'none';
            this.innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 8px;"></i>Create a Post';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-success');
          }
        });
      }

      if (cancelPostBtn) {
        cancelPostBtn.addEventListener('click', function() {
          createPostForm.style.display = 'none';
          createPostBtn.innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 8px;"></i>Create a Post';
          createPostBtn.classList.remove('btn-outline-secondary');
          createPostBtn.classList.add('btn-success');
        });
      }
    });
  </script>

  <style>
    .account-img {
      height: 125px;
      width: 125px;
      object-fit: cover;
    }
    
    .profile-header {
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .account-heading {
      font-size: 2.5rem;
    }
    
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .article-img {
      height: 65px;
      width: 65px;
      margin-right: 16px;
    }
  </style>
{% endblock content %}
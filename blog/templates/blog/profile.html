{% extends "blog/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
  <div class="content-section">
    <!-- Profile Header Section -->
    <div class="profile-header">
      <div class="row">
        <div class="col-md-3">
          <img class="rounded-circle account-img" src="{{ profile_user.profile.image.url }}" alt="{{ profile_user.username }}">
        </div>
        <div class="col-md-9">
          <h2 class="account-heading">{{ profile_user.username }}</h2>
          <p class="text-secondary">{{ profile_user.email }}</p>
          
          {% if profile_user == request.user %}
            <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#editProfileModal">
              Edit Profile
            </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Create Post Section (if it's the user's own profile) -->
    {% if profile_user == request.user %}
      <div class="content-section mb-4">
        <form method="POST">
          {% csrf_token %}
          <fieldset class="form-group">
            <legend class="border-bottom mb-4">Create a New Post</legend>
            {{ post_form|crispy }}
          </fieldset>
          <div class="form-group">
            <button class="btn btn-outline-info" type="submit">Post</button>
          </div>
        </form>
      </div>
    {% endif %}

    <!-- User's Posts Section -->
    <h3 class="mt-4 mb-3">Posts by {{ profile_user.username }}</h3>
    {% for post in posts %}
      <article class="media content-section">
        <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}">
        <div class="media-body">
          <div class="article-metadata">
            <a class="mr-2" href="{% url 'blog-profile' post.author.id %}">{{ post.author }}</a>
            <small class="text-muted">{{ post.date_posted|date:"F d, Y" }}</small>
          </div>
          <h2><a class="article-title" href="{% url 'blog-post' post.id %}">{{ post.title }}</a></h2>
          <p class="article-content">{{ post.content }}</p>
        </div>
      </article>
    {% empty %}
      <p>No posts yet.</p>
    {% endfor %}
  </div>

  <!-- Edit Profile Modal -->
  {% if profile_user == request.user %}
  <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            {% csrf_token %}
            {{ u_form|crispy }}
            {{ p_form|crispy }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button class="btn btn-outline-info" type="submit" name="update_profile">Update Profile</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- JavaScript to handle form submission errors -->
  <script>
    {% if u_form.errors or p_form.errors %}
      // If there are form errors, reopen the modal
      $(document).ready(function() {
        $('#editProfileModal').modal('show');
      });
    {% endif %}
  </script>

  <style>
    .account-img {
      height: 125px;
      width: 125px;
      object-fit: cover;
    }
    
    .profile-header {
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .account-heading {
      font-size: 2.5rem;
    }
    
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .article-img {
      height: 65px;
      width: 65px;
      margin-right: 16px;
    }
  </style>
{% endblock content %}
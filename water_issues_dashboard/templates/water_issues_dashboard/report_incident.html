{% extends 'water_issues_dashboard/base.html' %}
{% load static %}

{% block title %}Report an Incident{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h2>ðŸš¨ Report a New Incident</h2>
        <p>Help us track important incidents by providing detailed information below</p>
    </div>
    
    <div class="report-form-container">
        <div class="required-fields-note">
            All fields marked with * are required
        </div>

        <form method="post" id="incidentForm">
            {% csrf_token %}
            
            <div class="form-section">
                <h3>Incident Details</h3>
                
                <div class="form-group">
                    <label for="id_name">Incident Name</label>
                    {{ form.name }}
                    <div class="help-text">Provide a descriptive name for this incident</div>
                </div>
                
                <div class="form-group">
                    <label for="id_incident_type">Incident Type</label>
                    {{ form.incident_type }}
                    <div class="help-text">Select the type that best describes this incident</div>
                </div>
                
                <div class="form-group">
                    <label for="id_status">Status</label>
                    {{ form.status }}
                    <div class="help-text">Confirmed or suspected incident</div>
                </div>
                
                <div class="form-group">
                    <label for="id_started_at">Started Date</label>
                    {{ form.started_at }}
                    <div class="help-text">When did this incident begin?</div>
                </div>
                
                <div class="form-group">
                    <label for="id_description">Description</label>
                    {{ form.description }}
                    <div class="help-text">Provide additional details about the incident</div>
                </div>
            </div>

            {{ form.geometry }}

            <div class="form-section">
                <div class="map-section">
                    <h3>Draw Affected Area</h3>
                    <div class="map-instructions">
                        <p><strong>Instructions:</strong> Click on the map in four different locations to draw a polygon representing the affected area. Each click adds a marker. After four points, a polygon will automatically be created. Use the reset button below to start over if needed.</p>
                    </div>
                    <div id="map"></div>
                    <button type="button" id="resetButton">Reset Map</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Submit Report</button>
                <a href="{% url 'water_issues_dashboard:home' %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'water_issues_dashboard/report_incident_styles.css' %}">
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('map').setView([55.0, -97.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let points = [];
        let markers = [];
        let polygon = null;
        const geometryInput = document.getElementById('id_geometry');

        map.on('click', function(e) {
            if (points.length < 4) {
                const latlng = e.latlng;
                points.push(latlng);

                const marker = L.marker(latlng).addTo(map);
                markers.push(marker);

                if (points.length === 4) {
                    polygon = L.polygon(points, { 
                        color: '#5f788a',
                        fillColor: '#5f788a',
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(map);
                    
                    // Create a GeoJSON Polygon feature
                    const coordinates = points.map(p => [p.lng, p.lat]);
                    coordinates.push(coordinates[0]); // Close the polygon
                    
                    const geojson = {
                        type: "Polygon",
                        coordinates: [coordinates]
                    };
                    geometryInput.value = JSON.stringify(geojson);
                }
            } else {
                alert("You can only select 4 points. Please press 'Reset Map' to start over.");
            }
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            if (polygon) {
                map.removeLayer(polygon);
                polygon = null;
            }
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            points = [];
            geometryInput.value = '';
        });
    });
</script>
{% endblock %}